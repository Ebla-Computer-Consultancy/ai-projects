<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGPT Demo</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet"
          href="{{ url_for('static', filename='node_modules/@mdi/font/css/materialdesignicons.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='node_modules/bootstrap/dist/css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <style>
        .main-bg {
            position: relative;
            background: #8A1538 url("{{ url_for('static', filename='images/background.png') }}");
            background-size: cover;
        }
    </style>
</head>
<body class="main-bg h-100">
<div class="overlay"></div>
<div class="container h-100">
    <button class="btn btn-icon rounded-circle py-1 position-absolute mt-3">
        <a href="/">
            <i style="font-size: 40px" class="text-white mdi mdi-arrow-u-left-top"></i>
        </a>
    </button>
    <h2 class="text-center p-5 text-white">Welcome to EBLA Ai-chat</h2>
    <div class="d-flex flex-column align-items-center">
        <div class="card" style="width: 480px; min-height: 300px">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="text-primary mdi mdi-robot-happy mdi-24px"></i>
                    ChatGPT Demo
                </span>
                <button class="btn btn-outline-primary" id="toggle-fullscreen">
                    <i class="mdi mdi-arrow-expand-all"></i>
                </button>
            </div>
            <div class="text-center card-body overflow-auto">
                <small id="start-text" class="fw-bold">
                    Let's chat with me to help you.
                </small>
                <div class="chat-container" id="chat-container">
                </div>
                <div class="loading-text" id="loading-text">....<i class="mdi mdi-pen"></i></div>
            </div>
            <div class="card-footer">
                <form id="message-form">
                    <div class="input-group mb-3">
                        <input type="text" id="user-message" class="form-control-sm form-control"
                               placeholder="Type your message...">
                        <div class="input-group-append">
                            <button class="btn btn-sm btn-primary" type="submit"><i class="mdi mdi-send"></i>
                            </button>
                            <button id="clear-chat" type="button" class="btn btn-sm btn-outline-secondary ms-2">
                                Clear
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

    </div>
</div>
<div class="modal modal-lg" id="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header d-flex justify-content-between">
                <h5 class="modal-title">Citation Details</h5>
                <button type="button" class="btn btn-outline-secondary close close-modal" data-dismiss="modal"
                        aria-label="Close">
                    <i class="mdi mdi-close"></i>
                </button>
            </div>
            <div class="modal-body">
                <p dir="rtl" id="citation-content"></p>
                <strong>Link to document: </strong><a href="#" id="citation-link" target="_blank"></a>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close-modal" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='node_modules/jquery/dist/jquery.min.js') }}"></script>
<script src="{{ url_for('static', filename='node_modules/bootstrap/dist/js/bootstrap.min.js') }}"></script>
<script>
    const chatContainer = document.getElementById('chat-container');
    const messageForm = document.getElementById('message-form');
    const userMessageInput = document.getElementById('user-message');
    const toggleFullscreenButton = document.getElementById('toggle-fullscreen');
    const clearButton = document.getElementById('clear-chat');
    const card = document.querySelector('.card');
    const loadingText = document.getElementById('loading-text');
    const citationContent = document.getElementById('citation-content');
    const citationLink = document.getElementById('citation-link');

    document.querySelectorAll('.close-modal').forEach(elem => {
        elem.addEventListener('click', () => {
            $('#modal').modal('hide');
        })
    })

    messageHistory = [];  //initiating chat history

    toggleFullscreenButton.addEventListener('click', () => {
        card.classList.toggle('fullscreen');
        const icon = toggleFullscreenButton.querySelector('i');
        if (card.classList.contains('fullscreen')) {
            icon.classList.remove('mdi-arrow-expand-all');
            icon.classList.add('mdi-arrow-collapse-all');
        } else {
            icon.classList.remove('mdi-arrow-collapse-all');
            icon.classList.add('mdi-arrow-expand-all');
        }
    });

    clearButton.addEventListener('click', () => {
        while (chatContainer.firstChild) {
            chatContainer.removeChild(chatContainer.firstChild);
        }
        messageHistory = [];
        $('#start-text').show();
    });

    messageForm.addEventListener('submit', async function (event) {
        event.preventDefault();

        const userMessage = userMessageInput.value.trim();
        userMessageInput.value = '';
        if (!userMessage) return;
        $('#start-text').hide();

        appendMessage('user', userMessage);

        toggleLoading(true); // Show the loading text
        messageBody = JSON.stringify({
            "role": "user",
            "content": userMessage
        });

        messageHistory.push(messageBody); // saving question to history

        const response = await fetch('/chat-action', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({"messageHistory": messageHistory})
        });
        toggleLoading(false); // Hide the loading text
        const data = await response.json();
        if (data.error) {
            appendMessage('error', data.message);
            messageHistory.pop()  //remove the last question from message history
            if (!messageHistory.length) {
                $('#start-text').show();
            }
        } else {
            messageResponse = JSON.stringify({
                "role": "assistant",
                "content": data.message.content
            });
            messageHistory.push(messageResponse);   //saving answer to history
            console.log(data, messageHistory);
            if (data.message.context.citations) {
                var citations = data.message.context.citations;
                var links = citations.map(citation => {
                    var link = document.createElement('a');
                    link.href = "#";
                    link.textContent = citation.filepath;
                    link.classList.add('citation-link'); // Add a class for styling and event handling
                    link.addEventListener('click', (e) => {
                            e.preventDefault();
                            showCitationDialog(citation.content, citation.url, citation.filepath); // Add click event listener
                        }
                    )
                    return link;
                });
            }
            await appendMessageInteractive('assistant', data.message.content, links);

        }
    });

    async function appendMessage(role, content) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message');
        messageDiv.classList.add(role + '-message');

        const contentDiv = document.createElement('div');
        contentDiv.classList.add('message-content');
        contentDiv.textContent = content;

        messageDiv.appendChild(contentDiv);
        chatContainer.appendChild(messageDiv);

        // Scroll to bottom
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    async function appendMessageInteractive(role, content, refs) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message');
        messageDiv.classList.add(role + '-message');

        const contentDiv = document.createElement('div');
        contentDiv.classList.add('message-content');

        messageDiv.appendChild(contentDiv);
        chatContainer.appendChild(messageDiv);

        // Scroll to bottom
        chatContainer.scrollTop = chatContainer.scrollHeight;
        content = formatText(content);
        const collapsibleDiv = document.createElement('div');
        //prepare references dev
        if (refs && Array.isArray(refs) && refs.length) {
            const refDiv = document.createElement('div'); // Create a references div
            refs.forEach(ref => {
                refDiv.appendChild(ref); // Append each node in refs to refDiv
            });
            // Create container for icon and title
            const iconWithTitleDiv = document.createElement('div');
            iconWithTitleDiv.classList.add('icon-with-title');

            // Create icon element
            const icon = document.createElement('i');
            icon.classList.add('mdi', 'mdi-chevron-down', 'collapsible-icon'); // Font Awesome icon for down arrow
            iconWithTitleDiv.appendChild(icon);

            // Create title element
            const title = document.createElement('span');
            title.textContent = 'References'; // Set your title text here
            title.classList.add('title');
            iconWithTitleDiv.appendChild(title);


            // Add toggle functionality
            iconWithTitleDiv.addEventListener('click', () => {
                refDiv.classList.toggle('d-none');
                icon.classList.toggle('mdi-chevron-down');
                icon.classList.toggle('mdi-chevron-up');
            });
            collapsibleDiv.appendChild(iconWithTitleDiv);
            collapsibleDiv.appendChild(refDiv);
            // Initial hidden state
            refDiv.classList.add('d-none');

        }

        animateText(content, contentDiv, collapsibleDiv);
    }

    function formatText(text) {
        formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

        // Replace text between [ and ] with <a> tags
        formattedText = formattedText.replace(/\[(.*?)\]/g, '<a href="#">$1</a>');
        // text = text.replace(/\./g, '.<br>')

        // Return the formatted text
        return formattedText.trim();
    }


    function animateText(text, container, refs) {
        let index = 0;
        let currentText = '';
        addNextCharacter();

        function addNextCharacter() {
            currentText += text.charAt(index);
            container.innerHTML = currentText; // Render current text
            chatContainer.scrollTop = chatContainer.scrollHeight;
            index++;
            if (index < text.length) {
                setTimeout(addNextCharacter, 8); // Adjust speed here (milliseconds)
            } else {
                container.appendChild(refs);
            }
        }

    }

    function toggleLoading(isLoading) {
        if (isLoading) {
            loadingText.style.display = 'block';
        } else {
            loadingText.style.display = 'none';
        }
    }

    function showCitationDialog(content, url, filename) {
        $('#modal').modal('show');
        citationContent.textContent = content;
        citationLink.href = url;
        citationLink.textContent = filename;
    }

</script>
</body>
</html>
